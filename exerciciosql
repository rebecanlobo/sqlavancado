--1. APRESENTE A QUERY PARA LISTAR O CÓDIGO E O NOME DO VENDEDOR
-- COM MAIOR NÚMERO DE VENDAS (CONTAGEM), E QUE ESTAS VENDAS ESTEJAM
-- COM O STATUS CONCLUÍDA.

SELECT FV.CODIGOVENDEDOR, DV.NOMEVENDEDOR
FROM DW.dim_vendedor dv
JOIN DW.fato_vendas fv ON dv.codigovendedor = fv.codigovendedor
WHERE codigostatusvenda = '1'

-- 2. APRESENTE A QUERY PARA LISTAR O CÓDIGO E O NOME DO PRODUTO
-- MAIS VENDIDO ENTRE AS DATAS DE 2014-02-03 ATÉ 2018-02-02. AS COLUNAS
-- PRESENTES NO RESULTADO DEVEM SER CODIGOPRODUTO (CDPRO) E NOMEPRODUTO(NMPRO).
 SELECT dp.nomeproduto, dp.codigoproduto
 FROM dw.dim_produto dp
 JOIN dw.fato_vendas fv ON dp.codigoproduto = fv.codigoproduto
 WHERE datavenda between '2014-02-03' and '2018-02-02'
 AND quantidadevendas > 0 
 ORDER BY quantidadevendas DESC
 LIMIT 1;
 
 
 -- 3. APRESENTE A QUERY PARA LISTAR O CÓDIGO E O NOME DO CLIENTE
-- COM MAIOR GASTO NA LOJA. AS COLUNAS
-- PRESENTES NO RESULTADO DEVEM SER CODIGOCLIENTE (CDCLI), NOMECLIENTE (NMCLI) E GASTO,
-- ESTA ÚLTIMA REPRESENTANDO O SOMATÓRIO DAS VENDAS ATRIBUÍDAS AO CLIENTE.
 SELECT FV.CODIGOCLIENTE, DC.NOMECLIENTE,
 (FV.VALORUNITARIOVENDA) * (FV.QUANTIDADEVENDAS) AS GASTO 
 FROM DW.FATO_VENDAS FV
 INNER JOIN DW.DIM_CLIENTE DC ON FV.CODIGOCLIENTE = DC.CODIGOCLIENTE
 WHERE CODIGOSTATUSVENDA = 1
 GROUP BY FV.CODIGOCLIENTE, DC.NOMECLIENTE, GASTO
 ORDER BY GASTO DESC
 LIMIT 1;

-- 4. APRESENTE A QUERY PARA LISTAR O CÓDIGO, NOME E DATA DE NASCIMENTO DOS DEPENDENTES DO VENDEDOR
-- COM MENOR VALOR TOTAL BRUTO EM VENDAS (SENDO DIFERENTE DE ZERO).  AS COLUNAS PRESENTES NO RESULTADO 
-- DEVEM SER CODIGODEPENDENTE (CDDEP), NOMEDEPENDENTE (NMDEP) E DATANASCIMENTO (DTNASC).
SELECT DP.CODIGODEPENDENTE, DP.DATANASCIMENTODEPENDENTE, DP.NOMEDEPENDENTE,
SUM ((FV.VALORUNITARIOVENDA) * (FV.QUANTIDADEVENDAS)) AS VALORTOTALVENDA
FROM DW.DIM_DEPENDENTE DP
JOIN DW.FATO_VENDAS FV ON DP.CODIGOVENDEDOR = FV.CODIGOVENDEDOR
AND VALORTOTALVENDA <> 0
GROUP BY DP.CODIGODEPENDENTE, DP.DATANASCIMENTODEPENDENTE, DP.NOMEDEPENDENTE, VALORTOTALVENDA
ORDER BY VALORTOTALVENDA ASC
LIMIT 1;
-- O SELECT FUNCIONA, MAS O VALOR NÃO APARECE

-- 5. APRESENTE A QUERY PARA LISTAR OS 3 PRODUTOS MENOS VENDIDOS, PELOS CANAIS DE E-COMMERCE OU MATRIZ.
-- AS COLUNAS PRESENTES NO RESULTADO DEVEM SER CANALVENDAS (CANAL), CODIGOPRODUTO (CDPRO), NOMEPRODUTO (NMPRO),
-- E QUANTIDADE_VENDAS.
SELECT DISTINCT DP.CODIGOPRODUTO, DP.NOMEPRODUTO, FV.CODIGOCANAL, FV.QUANTIDADEVENDAS
FROM DW.FATO_VENDAS FV
JOIN (
SELECT DISTINCT DP.CODIGOPRODUTO, DP.NOMEPRODUTO
	FROM DW.DIM_PRODUTO DP) DP ON FV.CODIGOPRODUTO = DP.CODIGOPRODUTO
-- APESAR DO DISTINCT, O CODIGO 2 AINDA APARECE REPETIDO
WHERE CODIGOCANAL = 1 OR CODIGOCANAL = 2
ORDER BY QUANTIDADEVENDAS ASC
LIMIT 3;

-- 6. APRESENTE  A QUERY PARA LISTAR O GASTO MÉDIO POR ESTADO DA FEDERAÇÃO. AS COLUNAS PRESENTES NO RESULTADO 
-- DEVEM SER ESTADO E GASTOMEDIO.
SELECT CL.ESTADOCLIENTE,
ROUND (AVG (FV.VALORUNITARIOVENDA) * (FV.QUANTIDADEVENDAS), 2) AS GASTOMEDIO
FROM DW.DIM_CLIENTE CL
JOIN DW.FATO_VENDAS FV ON CL.CODIGOCLIENTE = FV.CODIGOCLIENTE
GROUP BY CL.ESTADOCLIENTE, FV.QUANTIDADEVENDAS


-- 7. APRESENTE A QUERY PARA LISTAR O CÓDIGO DAS VENDAS (CDVEN) IDENTIFICADAS COMO DELETADAS. APRESENTE O 
-- RESULTADO EM ORDEM CRESCENTE.
SELECT FV.DELETADO, FV.CODIGOVENDA
FROM DW.FATO_VENDAS FV
ORDER BY CODIGOVENDA ASC;

-- 8. APRESENTE A QUERY PARA LISTAR A QUANTIDADE MÉDIA VENDIDA DE CADA PRODUTO AGRUPADO POR ESTADO DA FEDERAÇÃO.
-- AS COLUNAS PRESENTES NO RESULTADO DEVEM SER ESTADO, NOMEPRODUTO E QUANTIDADEMEDIA. CONSIDERE ARREDONDAR 
-- O VALOR DA COLUNA QUANTIDADEMEDIA NA QUARTA CASA DECIMAL. ORDENE OS RESULTADOS PELO ESTADO (1°) E NOMEPRODUTO (2°).
SELECT CL.ESTADOCLIENTE,
AVG (FV.QUANTIDADEVENDAS) AS QUANTIDADEMEDIA
FROM DW.DIM_CLIENTE CL
JOIN DW.FATO_VENDAS FV ON CL.CODIGOCLIENTE = FV.CODIGOCLIENTE
-- ENTENDI QUE PARA ESSA TERIA QUE SER FEITO UM SUBSELECT, SÓ CONSEGUIRIA DESSA FORMA?
WHERE CODIGOPRODUTO = (
  SELECT CODIGOPRODUTO
  FROM DW.DIM_PRODUTO PD
  GROUP BY PD.CODIGOPRODUTO
  ORDER BY FV.QUANTIDADEVENDAS DESC
  LIMIT 1)

-- 9. CALCULE A RECEITA BRUTA POR ANO.
SELECT SUM ((QUANTIDADEVENDAS) * (VALORUNITARIOVENDA)) AS RECEITABRUTA,
FV.DATAVENDA
FROM DW.FATO_VENDAS FV
WHERE CODIGOSTATUSVENDA = 1
AND DATAVENDA BETWEEN '2022-01-01' AND '2022-12-31'
GROUP BY FV.DATAVENDA


--10. CALCULE A RECEITA BRUTA POR ANO E POR ESTADO.
SELECT SUM ((QUANTIDADEVENDAS) * (VALORUNITARIOVENDA)) BETWEEN 2010-01-01 AND 2011-01-01 AS RECEITABRUTA,
ESTADOCLIENTE AS ESTADO, FV.DATAVENDA
FROM DW.FATO_VENDAS FV
JOIN DW.DIM_CLIENTE CL ON FV.CODIGOCLIENTE = CL.CODIGOCLIENTE
WHERE CODIGOSTATUSVENDA = 1
GROUP BY ESTADOCLIENTE, DATAVENDA

-- 11. PROPONHA UM INDICADOR:
-- APRESENTE A QUERY PARA LISTAR O VENDEDOR COM MAIOR RECEITA BRUTA. AS COLUNAS 
-- PRESENTES NO RESULTADO DEVEM SER NOMEVENDEDOR, CODIGOVENDEDOR E RECEITABRUTA.
SELECT VD.NOMEVENDEDOR, VD.CODIGOVENDEDOR,
SUM ((QUANTIDADEVENDAS) * (VALORUNITARIOVENDA)) AS RECEITABRUTA
FROM DW.DIM_VENDEDOR VD
JOIN DW.FATO_VENDAS FV ON VD.CODIGOVENDEDOR = FV.CODIGOVENDEDOR
GROUP BY VD.NOMEVENDEDOR, VD.CODIGOVENDEDOR
LIMIT 1

-- 12. MONTE UMA VIEW PARA A QUERY DA QUESTÃO 5.
SELECT DISTINCT DP.CODIGOPRODUTO, DP.NOMEPRODUTO, FV.CODIGOCANAL, FV.QUANTIDADEVENDAS
FROM DW.FATO_VENDAS FV
JOIN (
SELECT DISTINCT DP.CODIGOPRODUTO, DP.NOMEPRODUTO
	FROM DW.DIM_PRODUTO DP) DP ON FV.CODIGOPRODUTO = DP.CODIGOPRODUTO
WHERE CODIGOCANAL = 1 OR CODIGOCANAL = 2
ORDER BY QUANTIDADEVENDAS ASC
LIMIT 3;

-- 13. MOSTRE O NOME DO VENDEDOR, SEM ESPAÇO NA FRENTE, E A QUANTIDADE DE DEPENDENTES (USANDO SUBSELECT).
SELECT VD.NOMEVENDEDOR, DP.CODIGODEPENDENTE
FROM DW.DIM_VENDEDOR VD
WHERE VD.NOMEVENDEDOR = TRIM (VD.NOMEVENDEDOR) 
IN (SELECT COUNT (DP.CODIGODEPENDENTE) AS QUANTIDADEDEPENDENTES
	-- DÚVIDA EM COMO FAZER O SUBSELECT
FROM DW.DIM_DEPENDENTE DP
GROUP BY CODIGODEPENDENTE)


-- OPCIONAL:
SELECT VD.PERCENTUALCOMI AS PERCENTUALCOMISSAO, VD.NOMEVENDEDOR, VD.CODIGOVENDEDOR,
FV.QUANTIDADEVENDAS * FV.VALORUNITARIOVENDA AS TOTALDEVENDAS,
ROUND (VD.PERCENTUALCOMI * FV.VALORUNITARIOVENDA, 2) AS COMISSAO
FROM DW.DIM_VENDEDOR VD
JOIN DW.FATO_VENDAS FV ON VD.CODIGOVENDEDOR = FV.CODIGOVENDEDOR
WHERE 1 = 1
